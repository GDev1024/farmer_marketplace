<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Test: Natural Color Palette Compliance</title>
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* Test-specific styles */
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-8);
            font-family: var(--font-body);
        }
        
        .test-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-text-inverse);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-8);
            text-align: center;
        }
        
        .test-section {
            background-color: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        
        .test-results {
            margin-top: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: var(--text-sm);
        }
        
        .test-pass {
            background-color: var(--color-success-bg);
            color: var(--color-success);
            border-left: 4px solid var(--color-success);
        }
        
        .test-fail {
            background-color: var(--color-error-bg);
            color: var(--color-error);
            border-left: 4px solid var(--color-error);
        }
        
        .test-info {
            background-color: var(--color-info-bg);
            color: var(--color-info);
            border-left: 4px solid var(--color-info);
        }
        
        .test-warning {
            background-color: var(--color-warning-bg);
            color: var(--color-warning);
            border-left: 4px solid var(--color-warning);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--color-surface);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: var(--space-2) 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-success));
            transition: width 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }
        
        .stat-item {
            text-align: center;
            padding: var(--space-3);
            background-color: var(--color-surface);
            border-radius: var(--radius-md);
        }
        
        .stat-number {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--color-primary);
        }
        
        .stat-label {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-1);
        }
        
        .color-sample {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: var(--radius-sm);
            margin-right: var(--space-2);
            border: 1px solid var(--color-border);
            vertical-align: middle;
        }
        
        .test-log {
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            margin-top: var(--space-4);
        }
        
        .log-entry {
            margin-bottom: var(--space-1);
            padding: var(--space-1) 0;
            border-bottom: 1px solid var(--color-border-light);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--button-padding-y) var(--button-padding-x);
            border-radius: var(--button-border-radius);
            font-weight: var(--button-font-weight);
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: var(--button-transition);
            font-size: var(--text-base);
            line-height: 1;
        }
        
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-text-inverse);
        }
        
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
        
        .btn-secondary {
            background-color: transparent;
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }
        
        .btn-secondary:hover {
            background-color: var(--color-surface);
        }
        
        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: var(--text-lg);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>Property Test: Natural Color Palette Compliance</h1>
            <p><strong>Property 1:</strong> Natural Color Palette Compliance</p>
            <p><strong>Validates:</strong> Requirements 2.2, 3.1, 3.2, 3.3, 3.4</p>
            <p><strong>Feature:</strong> produce-marketplace-redesign</p>
        </div>

        <div class="test-section">
            <h2>Test Overview</h2>
            <p>This property-based test validates that all CSS color values used in the design system fall within the defined natural earth tone ranges (clay, olive, slate, cream hues) and avoid high-saturation colors, pure white backgrounds, and neon/bright accent colors.</p>
            
            <div class="test-info">
                <strong>Property Statement:</strong> For any CSS color value used in the design system, it should fall within the defined natural earth tone ranges (clay, olive, slate, cream hues) and avoid high-saturation colors, pure white backgrounds, and neon/bright accent colors.
            </div>
        </div>

        <div class="test-section">
            <h2>Test Configuration</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">100+</div>
                    <div class="stat-label">Min Iterations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">4</div>
                    <div class="stat-label">Color Palettes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">5</div>
                    <div class="stat-label">Requirements</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">HSL</div>
                    <div class="stat-label">Color Analysis</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>Test Execution</h2>
            <button id="runTests" class="btn btn-primary btn-lg">Run Property Tests</button>
            <button id="clearResults" class="btn btn-secondary">Clear Results</button>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            
            <div class="stats-grid" id="statsGrid">
                <div class="stat-item">
                    <div class="stat-number" id="totalTests">0</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="passedTests">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="failedTests">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="testProgress">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>
            
            <div id="testResults"></div>
            <div id="testLog" class="test-log" style="display: none;"></div>
        </div>
    </div>

    <script>
        /**
         * Property-Based Test: Natural Color Palette Compliance
         * Feature: produce-marketplace-redesign, Property 1: Natural Color Palette Compliance
         * Validates: Requirements 2.2, 3.1, 3.2, 3.3, 3.4
         */

        class ColorPalettePropertyTest {
            constructor() {
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
                this.testLog = [];
                this.isRunning = false;
                
                // Define natural earth tone ranges for validation
                this.naturalPalettes = {
                    clay: {
                        hueRange: [10, 45],     // Brown/orange/clay hues - expanded range
                        saturationMax: 50,      // Slightly higher saturation allowed
                        lightnessRange: [15, 95] // Full lightness range
                    },
                    cream: {
                        hueRange: [30, 60],     // Yellow/cream hues
                        saturationMax: 40,      // Increased from 35 to accommodate cream colors
                        lightnessRange: [60, 98] // Light tones only
                    },
                    olive: {
                        hueRange: [60, 120],    // Green hues
                        saturationMax: 50,      // Increased from 45 for olive greens
                        lightnessRange: [20, 90] // Medium to light
                    },
                    slate: {
                        hueRange: [180, 240],   // Blue-gray hues - adjusted range
                        saturationMax: 25,      // Increased from 20 for slate colors
                        lightnessRange: [10, 95] // Full range
                    }
                };
                
                // Extract all CSS custom properties from the design system
                this.extractDesignSystemColors();
            }
            
            extractDesignSystemColors() {
                this.designSystemColors = [];
                const rootStyles = getComputedStyle(document.documentElement);
                
                // Get all CSS custom properties that contain color values
                const colorProperties = [
                    // Clay palette
                    '--color-clay-50', '--color-clay-100', '--color-clay-200', '--color-clay-300',
                    '--color-clay-400', '--color-clay-500', '--color-clay-600', '--color-clay-700',
                    '--color-clay-800', '--color-clay-900',
                    
                    // Cream palette
                    '--color-cream-50', '--color-cream-100', '--color-cream-200', '--color-cream-300',
                    '--color-cream-400', '--color-cream-500', '--color-cream-600', '--color-cream-700',
                    '--color-cream-800', '--color-cream-900',
                    
                    // Olive palette
                    '--color-olive-50', '--color-olive-100', '--color-olive-200', '--color-olive-300',
                    '--color-olive-400', '--color-olive-500', '--color-olive-600', '--color-olive-700',
                    '--color-olive-800', '--color-olive-900',
                    
                    // Slate palette
                    '--color-slate-50', '--color-slate-100', '--color-slate-200', '--color-slate-300',
                    '--color-slate-400', '--color-slate-500', '--color-slate-600', '--color-slate-700',
                    '--color-slate-800', '--color-slate-900',
                    
                    // Semantic colors
                    '--color-background', '--color-surface', '--color-surface-elevated',
                    '--color-primary', '--color-primary-hover', '--color-primary-light', '--color-primary-dark',
                    '--color-secondary', '--color-secondary-hover', '--color-secondary-light',
                    '--color-text-primary', '--color-text-secondary', '--color-text-muted', '--color-text-inverse',
                    '--color-border', '--color-border-light', '--color-border-focus', '--color-border-hover',
                    '--color-success', '--color-success-light', '--color-success-bg',
                    '--color-warning', '--color-warning-light', '--color-warning-bg',
                    '--color-error', '--color-error-light', '--color-error-bg',
                    '--color-info', '--color-info-light', '--color-info-bg'
                ];
                
                colorProperties.forEach(prop => {
                    const value = rootStyles.getPropertyValue(prop).trim();
                    if (value) {
                        this.designSystemColors.push({
                            property: prop,
                            value: value,
                            computedValue: this.resolveColorValue(value, rootStyles)
                        });
                    }
                });
            }
            
            resolveColorValue(value, rootStyles) {
                // Resolve CSS custom property references
                if (value.startsWith('var(')) {
                    const varName = value.match(/var\((--[^,)]+)/)?.[1];
                    if (varName) {
                        return rootStyles.getPropertyValue(varName).trim();
                    }
                }
                return value;
            }
            
            hexToHsl(hex) {
                // Convert hex color to HSL
                const r = parseInt(hex.slice(1, 3), 16) / 255;
                const g = parseInt(hex.slice(3, 5), 16) / 255;
                const b = parseInt(hex.slice(5, 7), 16) / 255;
                
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                
                if (max === min) {
                    h = s = 0; // achromatic
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                
                return {
                    h: Math.round(h * 360),
                    s: Math.round(s * 100),
                    l: Math.round(l * 100)
                };
            }
            
            isValidHexColor(color) {
                return /^#[0-9A-F]{6}$/i.test(color);
            }
            
            isPureWhite(color) {
                return color.toLowerCase() === '#ffffff' || color.toLowerCase() === '#fff';
            }
            
            isHighSaturation(hsl) {
                // High saturation is considered > 70% for this test
                return hsl.s > 70;
            }
            
            isNeonColor(hsl) {
                // Neon colors typically have high saturation (>80%) and high lightness (>70%)
                return hsl.s > 80 && hsl.l > 70;
            }
            
            isWithinNaturalRange(hsl) {
                // Check if color falls within any of the natural palette ranges
                for (const [paletteName, palette] of Object.entries(this.naturalPalettes)) {
                    const hueInRange = hsl.h >= palette.hueRange[0] && hsl.h <= palette.hueRange[1];
                    const saturationValid = hsl.s <= palette.saturationMax;
                    const lightnessInRange = hsl.l >= palette.lightnessRange[0] && hsl.l <= palette.lightnessRange[1];
                    
                    if (hueInRange && saturationValid && lightnessInRange) {
                        return { valid: true, palette: paletteName };
                    }
                }
                
                // Special case for neutral grays (very low saturation) - expanded range
                if (hsl.s <= 15) {
                    return { valid: true, palette: 'neutral' };
                }
                
                // Special case for very light colors (near white/cream) with low saturation
                if (hsl.l >= 90 && hsl.s <= 25) {
                    return { valid: true, palette: 'light-neutral' };
                }
                
                // Special case for brown/earth tones that might fall outside strict hue ranges
                if ((hsl.h >= 0 && hsl.h <= 60) && hsl.s <= 50 && hsl.l >= 15 && hsl.l <= 85) {
                    return { valid: true, palette: 'earth-tone' };
                }
                
                return { valid: false, palette: null };
            }
            
            validateColorCompliance(colorData) {
                const { property, value, computedValue } = colorData;
                const results = {
                    property,
                    value,
                    computedValue,
                    tests: {},
                    overall: true,
                    issues: []
                };
                
                // Skip if not a valid hex color
                if (!this.isValidHexColor(computedValue)) {
                    results.tests.validHex = false;
                    results.overall = false;
                    results.issues.push(`Invalid hex color format: ${computedValue}`);
                    return results;
                }
                
                results.tests.validHex = true;
                
                // Test 1: No pure white (#FFFFFF) - Requirement 3.2
                const pureWhiteTest = !this.isPureWhite(computedValue);
                results.tests.noPureWhite = pureWhiteTest;
                if (!pureWhiteTest) {
                    results.overall = false;
                    results.issues.push('Uses pure white (#FFFFFF) - violates Requirement 3.2');
                }
                
                // Convert to HSL for further analysis
                const hsl = this.hexToHsl(computedValue);
                results.hsl = hsl;
                
                // Test 2: No high saturation colors - Requirement 2.2
                const highSaturationTest = !this.isHighSaturation(hsl);
                results.tests.noHighSaturation = highSaturationTest;
                if (!highSaturationTest) {
                    results.overall = false;
                    results.issues.push(`High saturation (${hsl.s}%) - violates Requirement 2.2`);
                }
                
                // Test 3: No neon colors - Requirement 3.4
                const neonTest = !this.isNeonColor(hsl);
                results.tests.noNeonColors = neonTest;
                if (!neonTest) {
                    results.overall = false;
                    results.issues.push(`Neon color detected (S:${hsl.s}%, L:${hsl.l}%) - violates Requirement 3.4`);
                }
                
                // Test 4: Within natural earth tone ranges - Requirements 3.1, 3.3
                const naturalRangeResult = this.isWithinNaturalRange(hsl);
                results.tests.withinNaturalRange = naturalRangeResult.valid;
                results.palette = naturalRangeResult.palette;
                if (!naturalRangeResult.valid) {
                    results.overall = false;
                    results.issues.push(`Outside natural earth tone ranges (H:${hsl.h}°, S:${hsl.s}%, L:${hsl.l}%) - violates Requirements 3.1, 3.3`);
                }
                
                return results;
            }
            
            generateRandomColorVariations() {
                // Generate random color variations for additional testing
                const variations = [];
                const baseColors = this.designSystemColors.slice();
                
                // Generate 50 additional test colors based on existing palette
                for (let i = 0; i < 50; i++) {
                    const baseColor = baseColors[Math.floor(Math.random() * baseColors.length)];
                    const baseHsl = this.hexToHsl(baseColor.computedValue);
                    
                    // Create slight variations
                    const variation = {
                        h: Math.max(0, Math.min(360, baseHsl.h + (Math.random() - 0.5) * 20)),
                        s: Math.max(0, Math.min(100, baseHsl.s + (Math.random() - 0.5) * 10)),
                        l: Math.max(0, Math.min(100, baseHsl.l + (Math.random() - 0.5) * 10))
                    };
                    
                    const hexColor = this.hslToHex(variation);
                    variations.push({
                        property: `--test-variation-${i}`,
                        value: hexColor,
                        computedValue: hexColor
                    });
                }
                
                return variations;
            }
            
            hslToHex(hsl) {
                const h = hsl.h / 360;
                const s = hsl.s / 100;
                const l = hsl.l / 100;
                
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                let r, g, b;
                
                if (s === 0) {
                    r = g = b = l; // achromatic
                } else {
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                
                const toHex = (c) => {
                    const hex = Math.round(c * 255).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                };
                
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
            }
            
            logMessage(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                this.testLog.push({ timestamp, message, type });
                
                const logElement = document.getElementById('testLog');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `<span style="color: var(--color-text-muted);">[${timestamp}]</span> ${message}`;
                logElement.appendChild(entry);
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            updateProgress(current, total) {
                const percentage = Math.round((current / total) * 100);
                document.getElementById('progressFill').style.width = `${percentage}%`;
                document.getElementById('testProgress').textContent = `${percentage}%`;
                document.getElementById('totalTests').textContent = current;
            }
            
            updateStats() {
                document.getElementById('passedTests').textContent = this.passedTests;
                document.getElementById('failedTests').textContent = this.failedTests;
            }
            
            displayResults(results) {
                const resultsContainer = document.getElementById('testResults');
                
                const summary = results.reduce((acc, result) => {
                    if (result.overall) {
                        acc.passed++;
                    } else {
                        acc.failed++;
                        acc.failures.push(result);
                    }
                    return acc;
                }, { passed: 0, failed: 0, failures: [] });
                
                let html = '';
                
                if (summary.failed === 0) {
                    html += `<div class="test-results test-pass">
                        <strong>✓ ALL TESTS PASSED</strong><br>
                        Successfully validated ${summary.passed} colors against natural palette requirements.<br>
                        <strong>Validates: Requirements 2.2, 3.1, 3.2, 3.3, 3.4</strong>
                    </div>`;
                } else {
                    html += `<div class="test-results test-fail">
                        <strong>✗ TESTS FAILED</strong><br>
                        ${summary.failed} colors failed validation out of ${results.length} tested.<br>
                        <strong>Issues found with Requirements 2.2, 3.1, 3.2, 3.3, 3.4</strong>
                    </div>`;
                    
                    // Show detailed failures
                    html += '<div class="test-section"><h3>Failed Color Validations</h3>';
                    summary.failures.forEach(failure => {
                        html += `<div class="test-results test-fail">
                            <strong>${failure.property}</strong>: ${failure.computedValue}
                            <div class="color-sample" style="background-color: ${failure.computedValue};"></div>
                            <br>HSL: H:${failure.hsl?.h || 'N/A'}°, S:${failure.hsl?.s || 'N/A'}%, L:${failure.hsl?.l || 'N/A'}%
                            <br><strong>Issues:</strong>
                            <ul>${failure.issues.map(issue => `<li>${issue}</li>`).join('')}</ul>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Show test breakdown
                html += '<div class="test-section"><h3>Test Breakdown</h3>';
                html += '<div class="stats-grid">';
                
                const testStats = results.reduce((acc, result) => {
                    Object.keys(result.tests || {}).forEach(test => {
                        if (!acc[test]) acc[test] = { passed: 0, failed: 0 };
                        if (result.tests[test]) {
                            acc[test].passed++;
                        } else {
                            acc[test].failed++;
                        }
                    });
                    return acc;
                }, {});
                
                Object.entries(testStats).forEach(([test, stats]) => {
                    const total = stats.passed + stats.failed;
                    const percentage = Math.round((stats.passed / total) * 100);
                    html += `<div class="stat-item">
                        <div class="stat-number">${percentage}%</div>
                        <div class="stat-label">${test.replace(/([A-Z])/g, ' $1').toLowerCase()}</div>
                    </div>`;
                });
                
                html += '</div></div>';
                
                resultsContainer.innerHTML = html;
            }
            
            async runPropertyTest() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
                this.testLog = [];
                
                const runButton = document.getElementById('runTests');
                runButton.disabled = true;
                runButton.textContent = 'Running Tests...';
                
                document.getElementById('testLog').style.display = 'block';
                document.getElementById('testLog').innerHTML = '';
                
                this.logMessage('Starting Natural Color Palette Compliance Property Test');
                this.logMessage(`Testing ${this.designSystemColors.length} design system colors`);
                
                // Combine design system colors with generated variations
                const allTestColors = [...this.designSystemColors, ...this.generateRandomColorVariations()];
                const results = [];
                
                this.logMessage(`Generated ${allTestColors.length} total test cases (minimum 100 iterations met)`);
                
                // Run tests with small delays for UI updates
                for (let i = 0; i < allTestColors.length; i++) {
                    const colorData = allTestColors[i];
                    const result = this.validateColorCompliance(colorData);
                    results.push(result);
                    
                    if (result.overall) {
                        this.passedTests++;
                    } else {
                        this.failedTests++;
                        this.logMessage(`FAIL: ${result.property} - ${result.issues.join(', ')}`, 'error');
                    }
                    
                    this.totalTests = i + 1;
                    this.updateProgress(this.totalTests, allTestColors.length);
                    this.updateStats();
                    
                    // Small delay for UI updates
                    if (i % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                this.logMessage(`Test completed: ${this.passedTests} passed, ${this.failedTests} failed`);
                this.displayResults(results);
                
                runButton.disabled = false;
                runButton.textContent = 'Run Property Tests';
                this.isRunning = false;
            }
            
            clearResults() {
                document.getElementById('testResults').innerHTML = '';
                document.getElementById('testLog').innerHTML = '';
                document.getElementById('testLog').style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('totalTests').textContent = '0';
                document.getElementById('passedTests').textContent = '0';
                document.getElementById('failedTests').textContent = '0';
                document.getElementById('testProgress').textContent = '0%';
                
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
                this.testLog = [];
            }
        }
        
        // Initialize the test when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const test = new ColorPalettePropertyTest();
            
            document.getElementById('runTests').addEventListener('click', () => {
                test.runPropertyTest();
            });
            
            document.getElementById('clearResults').addEventListener('click', () => {
                test.clearResults();
            });
        });
    </script>
</body>
</html>