container_commands:
  01_run_migrations:
    command: "php /var/app/ondeck/root/includes/migrate.php"
    leader_only: true
    ignoreErrors: true

files:
  "/var/app/ondeck/root/includes/migrate.php":
    mode: "000755"
    owner: webapp
    group: webapp
    content: |
      <?php
      // Simple migration runner for AWS deployment
      require_once __DIR__ . '/config.php';
      
      try {
          $db = Config::getDB();
          
          // Check if tables exist, if not run the SQL file
          $stmt = $db->query("SHOW TABLES LIKE 'users'");
          if ($stmt->rowCount() == 0) {
              $sql = file_get_contents(__DIR__ . '/grenada_marketplace.sql');
              $db->exec($sql);
              echo "Database tables created successfully.\n";
          } else {
              echo "Database tables already exist.\n";
          }
      } catch (Exception $e) {
          echo "Migration error: " . $e->getMessage() . "\n";
          exit(1);
      }
      ?>